<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>3D Force Graph - Click to Focus + Text Nodes + Arrows</title>
  <style>
    body { margin: 0; }
    #3d-graph { width: 100vw; height: 100vh; }
  </style>

  <script src="//cdn.jsdelivr.net/npm/3d-force-graph"></script>
</head>

<body>
  <div id="3d-graph"></div>

  <script type="module">
    import SpriteText from "https://esm.sh/three-spritetext";

    const elem = document.getElementById('3d-graph');

    const Graph = new ForceGraph3D(elem)
      .jsonUrl('./blocks3.json')
      .nodeAutoColorBy('user')
      .nodeLabel(node => `${node.user}: ${node.description}`)
      // âœ… æ·»åŠ ç®­å¤´
      .linkDirectionalArrowLength(3.5)
      .linkDirectionalArrowRelPos(1)
      // âœ… æ”¹ä¸ºæ–‡å­—èŠ‚ç‚¹
      .nodeThreeObject(node => {
        const sprite = new SpriteText(node.user); // æ˜¾ç¤ºç”¨æˆ·åæˆ–ä»»æ„å­—æ®µ
        sprite.color = node.color;                // ä¸è‡ªåŠ¨é¢œè‰²ä¸€è‡´
        sprite.material.depthWrite = false;       // æ–‡å­—èƒŒæ™¯é€æ˜
        sprite.textHeight = 8;                    // ğŸ”¸ æ§åˆ¶å­—ä½“å¤§å°ï¼ˆé»˜è®¤çº¦8~10ï¼‰
        sprite.center.y = -0.5;                   // ç¨å¾®è°ƒæ•´å‚ç›´ä½ç½®
        return sprite;
      })
      .nodeThreeObjectExtend(true)
      // ==============================
      // æ‚¬åœæ—¶æ”¹å˜é¼ æ ‡æ ·å¼
      .onNodeHover(node => { elem.style.cursor = node ? 'pointer' : null; })
      // ç‚¹å‡»èšç„¦ï¼ˆæ”¯æŒ Ctrl/Cmd/ä¸­é”®æ‰“å¼€é“¾æ¥ï¼‰
      .onNodeClick((node, event) => {
        const url = `https://bl.ocks.org/${node.user}/${node.id}`;

        // è‹¥æŒ‰ä½ Ctrl/Cmd æˆ–ç”¨ä¸­é”®ï¼Œåˆ™ä¿æŒåŸæ¥â€œæ–°å¼€æ ‡ç­¾é¡µâ€çš„è¡Œä¸º
        if (event && (event.ctrlKey || event.metaKey || event.button === 1)) {
          window.open(url, '_blank');
          return;
        }

        // â€”â€” å¦åˆ™æ‰§è¡Œèšç„¦ â€”â€” //
        const distance = 300;
        const x = node.x || 0, y = node.y || 0, z = node.z || 0;
        const distRatio = 1 + distance / Math.hypot(x, y, z || 1);
        const newPos = (x || y || z)
          ? { x: x * distRatio, y: y * distRatio, z: z * distRatio }
          : { x: distance, y: distance, z: distance };

        Graph.cameraPosition(newPos, node, 1500);
      });
  </script>
</body>
</html>
