<!-- <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>3D Force Graph - Click to Focus + Text Nodes + Arrows</title>
  <style>
    body { margin: 0; }
    #3d-graph { width: 100vw; height: 100vh; }
  </style>

  <script src="//cdn.jsdelivr.net/npm/3d-force-graph"></script>
</head>

<body>
  <div id="3d-graph"></div>

  <script type="module">
    import SpriteText from "https://esm.sh/three-spritetext";

    const elem = document.getElementById('3d-graph');

    const Graph = new ForceGraph3D(elem)
      .jsonUrl('./blocks3.json')
      .nodeAutoColorBy('user')
      .nodeLabel(node => `${node.user}: ${node.description}`)
      // âœ… æ·»åŠ ç®­å¤´
      .linkDirectionalArrowLength(3.5)
      .linkDirectionalArrowRelPos(1)
      // âœ… æ”¹ä¸ºæ–‡å­—èŠ‚ç‚¹
      .nodeThreeObject(node => {
        const sprite = new SpriteText(node.user); // æ˜¾ç¤ºç”¨æˆ·åæˆ–ä»»æ„å­—æ®µ
        sprite.color = node.color;                // ä¸è‡ªåŠ¨é¢œè‰²ä¸€è‡´
        sprite.material.depthWrite = false;       // æ–‡å­—èƒŒæ™¯é€æ˜
        sprite.textHeight = 8;                    // ğŸ”¸ æ§åˆ¶å­—ä½“å¤§å°ï¼ˆé»˜è®¤çº¦8~10ï¼‰
        sprite.center.y = -0.5;                   // ç¨å¾®è°ƒæ•´å‚ç›´ä½ç½®
        return sprite;
      })
      .nodeThreeObjectExtend(true)

      // ==============================
      // âœ… è®©èŠ‚ç‚¹æ›´èšæ‹¢ (æ ¸å¿ƒä¿®æ”¹)
      // ==============================
      // å‡å¼±èŠ‚ç‚¹é—´çš„æ’æ–¥åŠ› (charge force)ã€‚
      // é»˜è®¤å€¼é€šå¸¸æ˜¯ -30 å·¦å³ã€‚å°†å…¶è®¾ç½®å¾—æ›´æ¥è¿‘ 0 (ä¾‹å¦‚ -15)ï¼Œä¼šä½¿æ’æ–¥åŠ›å˜å°ï¼ŒèŠ‚ç‚¹å› æ­¤é å¾—æ›´è¿‘ã€‚
      // .d3Force('charge', d3.forceManyBody().strength(-100))

      // ==============================
      // æ‚¬åœæ—¶æ”¹å˜é¼ æ ‡æ ·å¼
      .onNodeHover(node => { elem.style.cursor = node ? 'pointer' : null; })
      // ç‚¹å‡»èšç„¦ï¼ˆæ”¯æŒ Ctrl/Cmd/ä¸­é”®æ‰“å¼€é“¾æ¥ï¼‰
      .onNodeClick((node, event) => {
        const url = `https://bl.ocks.org/${node.user}/${node.id}`;

        // è‹¥æŒ‰ä½ Ctrl/Cmd æˆ–ç”¨ä¸­é”®ï¼Œåˆ™ä¿æŒåŸæ¥â€œæ–°å¼€æ ‡ç­¾é¡µâ€çš„è¡Œä¸º
        if (event && (event.ctrlKey || event.metaKey || event.button === 1)) {
          window.open(url, '_blank');
          return;
        }

        // â€”â€” å¦åˆ™æ‰§è¡Œèšç„¦ â€”â€” //
        const distance = 300;
        const x = node.x || 0, y = node.y || 0, z = node.z || 0;
        const distRatio = 1 + distance / Math.hypot(x, y, z || 1);
        const newPos = (x || y || z)
          ? { x: x * distRatio, y: y * distRatio, z: z * distRatio }
          : { x: distance, y: distance, z: distance };

        Graph.cameraPosition(newPos, node, 1500);
      });
  </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>3D Force Graph - è‡ªåŠ¨æ—‹è½¬ + æ–‡æœ¬èŠ‚ç‚¹ + ç®­å¤´</title>
  <style>
    body { margin: 0; }
    #3d-graph { width: 100vw; height: 100vh; }
  </style>

  <script src="//cdn.jsdelivr.net/npm/3d-force-graph"></script>
</head>

<body>
  <div id="3d-graph"></div>

  <script type="module">
    import SpriteText from "https://esm.sh/three-spritetext";

    const elem = document.getElementById('3d-graph');

    const Graph = new ForceGraph3D(elem)
      .jsonUrl('../blocks3.json')
      .nodeAutoColorBy('user')
      .nodeLabel(node => `${node.user}: ${node.description}`)
      // âœ… æ·»åŠ ç®­å¤´
      .linkDirectionalArrowLength(3.5)
      .linkDirectionalArrowRelPos(1)
      // âœ… æ”¹ä¸ºæ–‡å­—èŠ‚ç‚¹
      .nodeThreeObject(node => {
        const sprite = new SpriteText(node.user);
        sprite.color = node.color;
        sprite.material.depthWrite = false;
        sprite.textHeight = 8;
        sprite.center.y = -0.5;
        return sprite;
      })
      .nodeThreeObjectExtend(true)
      // æ‚¬åœæ—¶æ”¹å˜é¼ æ ‡æ ·å¼
      .onNodeHover(node => { elem.style.cursor = node ? 'pointer' : null; })
      // ç‚¹å‡»èšç„¦
      .onNodeClick((node, event) => {
        const url = `https://bl.ocks.org/${node.user}/${node.id}`;
        if (event && (event.ctrlKey || event.metaKey || event.button === 1)) {
          window.open(url, '_blank');
          return;
        }
        const distance = 600;
        const x = node.x || 0, y = node.y || 0, z = node.z || 0;
        const distRatio = 1 + distance / Math.hypot(x, y, z || 1);
        const newPos = (x || y || z)
          ? { x: x * distRatio, y: y * distRatio, z: z * distRatio }
          : { x: distance, y: distance, z: distance };
        Graph.cameraPosition(newPos, node, 1500);
      });

    // ==============================
    // âœ… è‡ªåŠ¨æ—‹è½¬æ‘„åƒæœº
    // ==============================
    const ORBIT_DISTANCE = 2200;      // é•œå¤´è·ç¦»ä¸­å¿ƒçš„åŠå¾„
    const STEP = Math.PI / 1200;      // æ¯å¸§æ—‹è½¬è§’åº¦ï¼ˆè¶Šå°è¶Šæ…¢ï¼‰
    const TICK_MS = 16;              // åˆ·æ–°é—´éš”ï¼ˆçº¦60fpsï¼‰
    let angle = 0;

    // åˆå§‹åŒ–æ‘„åƒæœºä½ç½®
    Graph.cameraPosition({ x: 0, y: 0, z: ORBIT_DISTANCE });

    // å¯åŠ¨è‡ªåŠ¨æ—‹è½¬
    setInterval(() => {
      angle += STEP;
      const x = ORBIT_DISTANCE * Math.sin(angle);
      const z = ORBIT_DISTANCE * Math.cos(angle);
      Graph.cameraPosition({ x, y: 0, z });
    }, TICK_MS);
  </script>
</body>
</html>
